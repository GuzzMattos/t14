rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function para verificar se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function para verificar se o usuário é o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function para verificar se o usuário é membro de um grupo
    function isGroupMember(groupId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/group/$(groupId)) &&
             get(/databases/$(database)/documents/group/$(groupId)).data.memberIds.hasAny([request.auth.uid]);
    }
    
    // Coleção: users
    match /users/{userId} {
      // Usuários podem ler seu próprio perfil
      allow read: if isOwner(userId);
      
      // Usuários podem atualizar seu próprio perfil (incluindo avatar)
      // O campo avatar contém a URL da imagem armazenada no Firebase Storage
      allow update: if isOwner(userId);
      
      // Usuários podem criar seu próprio perfil
      allow create: if isOwner(userId);
      
      // Usuários podem deletar seu próprio perfil
      allow delete: if isOwner(userId);
      
      // Qualquer usuário autenticado pode ler outros usuários (para buscar amigos)
      // Isso permite ler o campo avatar de outros usuários para exibir fotos de perfil
      allow read: if isAuthenticated();
    }
    
    // Coleção: friends
    match /friends/{friendId} {
      // Usuários podem ler suas próprias relações de amizade
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.friendId == request.auth.uid);
      
      // Usuários podem criar relações de amizade onde são o userId OU o friendId
      // Isso permite que ao aceitar um convite, ambos os usuários possam criar a relação
      allow create: if isAuthenticated() && 
                       (request.resource.data.userId == request.auth.uid || 
                        request.resource.data.friendId == request.auth.uid);
      
      // Usuários podem atualizar suas próprias relações de amizade
      allow update: if isAuthenticated() && 
                      (resource.data.userId == request.auth.uid || 
                       resource.data.friendId == request.auth.uid);
    }
    
    // Coleção: friendRequests
    match /friendRequests/{requestId} {
      // Usuários podem ler solicitações que enviaram ou receberam
      allow read: if isAuthenticated() && 
                     (resource.data.fromUserId == request.auth.uid || 
                      resource.data.toUserId == request.auth.uid);
      
      // Usuários podem criar solicitações onde são o remetente
      allow create: if isAuthenticated() && 
                       request.resource.data.fromUserId == request.auth.uid;
      
      // Usuários podem atualizar solicitações que receberam (para aceitar/rejeitar)
      // Permite atualizar status de PENDING para ACCEPTED ou REJECTED
      allow update: if isAuthenticated() && 
                      resource.data.toUserId == request.auth.uid &&
                      resource.data.status == "PENDING" &&
                      (request.resource.data.status == "ACCEPTED" || 
                       request.resource.data.status == "REJECTED");
    }
    
    // Coleção: notifications
    match /notifications/{notificationId} {
      // Usuários podem ler suas próprias notificações
      allow read: if isAuthenticated() && 
                     resource != null &&
                     resource.data.userId == request.auth.uid;
      
      // Qualquer usuário autenticado pode criar notificações (o sistema cria para outros usuários)
      allow create: if isAuthenticated();
      
      // Usuários podem atualizar suas próprias notificações (marcar como lida)
      allow update: if isAuthenticated() && 
                      resource != null &&
                      resource.data.userId == request.auth.uid;
      
      // Usuários podem deletar suas próprias notificações
      // Verifica se o documento existe e pertence ao usuário
      allow delete: if isAuthenticated() && 
                      resource != null &&
                      resource.data.userId == request.auth.uid;
    }
    
    // Coleção: group
    match /group/{groupId} {
      // Usuários podem ler grupos dos quais são membros
      allow read: if isAuthenticated() && 
                     (resource.data.memberIds.hasAny([request.auth.uid]) || 
                      resource.data.ownerId == request.auth.uid);
      
      // Usuários podem criar grupos
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Apenas o dono pode atualizar o grupo
      allow update: if isAuthenticated() && 
                      (resource.data.ownerId == request.auth.uid ||
                       request.resource.data.ownerId == request.auth.uid);
      
      // Apenas o dono pode deletar o grupo
      allow delete: if isAuthenticated() && 
                      resource.data.ownerId == request.auth.uid;
    }
    
    // Coleção: expenses (UNIFICADO - única coleção de despesas)
    match /expenses/{expenseId} {
      // Usuários podem ler despesas de grupos dos quais são membros
      allow read: if isAuthenticated() && 
                     resource != null &&
                     exists(/databases/$(database)/documents/group/$(resource.data.groupId)) &&
                     get(/databases/$(database)/documents/group/$(resource.data.groupId)).data.memberIds.hasAny([request.auth.uid]);
      
      // Usuários podem criar despesas em grupos dos quais são membros
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/group/$(request.resource.data.groupId)) &&
                       get(/databases/$(database)/documents/group/$(request.resource.data.groupId)).data.memberIds.hasAny([request.auth.uid]);
      
      // Apenas o dono do grupo pode atualizar despesas (aprovar/rejeitar)
      // OU o criador da despesa pode atualizar divisões (marcar como pago)
      allow update: if isAuthenticated() && 
                      resource != null &&
                      exists(/databases/$(database)/documents/group/$(resource.data.groupId)) &&
                      (get(/databases/$(database)/documents/group/$(resource.data.groupId)).data.ownerId == request.auth.uid ||
                       resource.data.createdBy == request.auth.uid);
      
      // Apenas o criador ou dono do grupo pode deletar despesas
      allow delete: if isAuthenticated() && 
                      resource != null &&
                      (resource.data.createdBy == request.auth.uid ||
                       (exists(/databases/$(database)/documents/group/$(resource.data.groupId)) &&
                        get(/databases/$(database)/documents/group/$(resource.data.groupId)).data.ownerId == request.auth.uid));
    }
    
    // Coleção: pagamentos
    match /pagamentos/{paymentId} {
      // Usuários podem ler pagamentos relacionados a despesas de grupos dos quais são membros
      allow read: if isAuthenticated() && 
                     resource != null &&
                     exists(/databases/$(database)/documents/expenses/$(resource.data.despesaId)) &&
                     exists(/databases/$(database)/documents/group/$(get(/databases/$(database)/documents/expenses/$(resource.data.despesaId)).data.groupId)) &&
                     get(/databases/$(database)/documents/group/$(get(/databases/$(database)/documents/expenses/$(resource.data.despesaId)).data.groupId)).data.memberIds.hasAny([request.auth.uid]);
      
      // Usuários podem criar pagamentos para despesas de grupos dos quais são membros
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/expenses/$(request.resource.data.despesaId)) &&
                       exists(/databases/$(database)/documents/group/$(get(/databases/$(database)/documents/expenses/$(request.resource.data.despesaId)).data.groupId)) &&
                       get(/databases/$(database)/documents/group/$(get(/databases/$(database)/documents/expenses/$(request.resource.data.despesaId)).data.groupId)).data.memberIds.hasAny([request.auth.uid]) &&
                       request.resource.data.deUsuarioId == request.auth.uid;
      
      // Apenas o criador da despesa pode atualizar pagamentos (confirmar/rejeitar)
      allow update: if isAuthenticated() && 
                      resource != null &&
                      exists(/databases/$(database)/documents/expenses/$(resource.data.despesaId)) &&
                      get(/databases/$(database)/documents/expenses/$(resource.data.despesaId)).data.createdBy == request.auth.uid;
      
      // Usuários podem deletar pagamentos que criaram
      allow delete: if isAuthenticated() && 
                      resource != null &&
                      resource.data.createdBy == request.auth.uid;
    }
  }
}
